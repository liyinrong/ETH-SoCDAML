function [ data, fdata ] = feature_creation( data_in, fs )
%FEATURE_EXTRACTION filters input signals and creates moving window
% features

% -- Bandpass filter --
%d_bp = fdesign.bandpass('Fst1,Fp1,Fp2,Fst2,Ast1,Ap,Ast2',...
%                    2,6,12,15,60,1,60,fs);
%Hd_bp = design(d_bp);
% hard coded for profiling
Hd_bp.numerator = [-6.594541e-04, -3.651478e-04, -3.651463e-04, -2.748437e-04, -7.864601e-05, 2.233047e-04, 6.120718e-04, 1.048951e-03, 1.479213e-03, 1.838205e-03, 2.061544e-03, 2.095602e-03, 1.909362e-03, 1.502151e-03, 9.085999e-04, 1.956420e-04, -5.446797e-04, -1.209819e-03, -1.702707e-03, -1.951847e-03, -1.926585e-03, -1.649066e-03, -1.193493e-03, -6.801451e-04, -2.571983e-04, -7.724229e-05, -2.619548e-04, -8.817891e-04, -1.927703e-03, -3.301860e-03, -4.822892e-03, -6.241968e-03, -7.279704e-03, -7.667394e-03, -7.196367e-03, -5.759527e-03, -3.383684e-03, -2.404834e-04, 3.363359e-03, 7.021736e-03, 1.028294e-02, 1.271795e-02, 1.398977e-02, 1.391584e-02, 1.250870e-02, 9.988977e-03, 6.763097e-03, 3.369828e-03, 3.981163e-04, -1.610627e-03, -2.261233e-03, -1.387379e-03, 8.947404e-04, 4.176481e-03, 7.794582e-03, 1.091364e-02, 1.264875e-02, 1.220593e-02, 9.026130e-03, 2.905334e-03, -5.926347e-03, -1.678464e-02, -2.857648e-02, -3.991091e-02, -4.926257e-02, -5.516899e-02, -5.643490e-02, -5.231549e-02, -4.265075e-02, -2.792982e-02, -9.272944e-03, 1.167019e-02, 3.289579e-02, 5.227389e-02, 6.779871e-02, 7.783144e-02, 8.129989e-02, 7.783144e-02, 6.779871e-02, 5.227389e-02, 3.289579e-02, 1.167019e-02, -9.272944e-03, -2.792982e-02, -4.265075e-02, -5.231549e-02, -5.643490e-02, -5.516899e-02, -4.926257e-02, -3.991091e-02, -2.857648e-02, -1.678464e-02, -5.926347e-03, 2.905334e-03, 9.026130e-03, 1.220593e-02, 1.264875e-02, 1.091364e-02, 7.794582e-03, 4.176481e-03, 8.947404e-04, -1.387379e-03, -2.261233e-03, -1.610627e-03, 3.981163e-04, 3.369828e-03, 6.763097e-03, 9.988977e-03, 1.250870e-02, 1.391584e-02, 1.398977e-02, 1.271795e-02, 1.028294e-02, 7.021736e-03, 3.363359e-03, -2.404834e-04, -3.383684e-03, -5.759527e-03, -7.196367e-03, -7.667394e-03, -7.279704e-03, -6.241968e-03, -4.822892e-03, -3.301860e-03, -1.927703e-03, -8.817891e-04, -2.619548e-04, -7.724229e-05, -2.571983e-04, -6.801451e-04, -1.193493e-03, -1.649066e-03, -1.926585e-03, -1.951847e-03, -1.702707e-03, -1.209819e-03, -5.446797e-04, 1.956420e-04, 9.085999e-04, 1.502151e-03, 1.909362e-03, 2.095602e-03, 2.061544e-03, 1.838205e-03, 1.479213e-03, 1.048951e-03, 6.120718e-04, 2.233047e-04, -7.864601e-05, -2.748437e-04, -3.651463e-04, -3.651478e-04, -6.594541e-04];

data_bp = filtfilt(Hd_bp.numerator,1,data_in); 

% -- Derivative Filter --
%  H(z) = (1/8T) (-z^(-2) - 2*z^(-1) + 2*z + z^(2))
Hd_d_b = [1 2 0 -2 -1]; 
data_d = filtfilt(Hd_d_b,1,data_bp);

% -- Squaring --
s_fact = 1/100;
data_s = data_d.^2*s_fact;

% -- moving average --
w = 30;
data_ma = conv(data_s,ones(1 ,w)/w,'same');

% Data Outputs
data.data_bp = data_bp;
data.data_d = data_d;
data.data_s = data_s;
data.data_ma = data_ma;

% Filter outputs
fdata.bp_FIR = Hd_bp.numerator;
fdata.d_FIR = Hd_d_b;
fdata.s_fact = s_fact;
fdata.conv_w = w;

end

